{% extends 'iSkyLIMS_drylab/base.html' %}
{% load static %}
{% block content %}
{% load mptt_tags %}
{% load l10n %}
{% if display_service_for_user %}
    <h1><div class="color-heading">Service Information for the service {{ display_service_for_user.service_name}}</div></h1>
    <div class="row row-space-2 margin-b-4">
        <div class="col-sm-6">  <!-- general information from service -->
            <div class="panel panel-default">
                <div class="panel-heading"><h3>Service requested information</h3></div>
                <div class="panel-body">
                    <table class="table table-hover">
                        <tbody>
                            <tr>
                                <td>Service is in State:  </td>
                                <td> {{ display_service_for_user.state }} </td>
                            </tr>

                            <tr>
                                <td>File uploaded for the service:  </td>
                                {% if display_service_for_user.file %}
                                    <td><a href="{{ display_service_for_user.file }}" download> File used  <span class="glyphicon glyphicon-download-alt"></span></a></td>
                                {% else %}
                                    <td>No file uploaded</td>
                                {% endif %}
                            </tr>

                            {% for text, value in display_service_for_user.service_dates %}
                                <tr>
                                    <td>{{ text }}</td>
                                    <td>{{ value }}</td>
                                </tr>
                            {% endfor%}
                            <tr>
                                <td>Estimated Delivery date </td>
                                <td>{{ display_service_for_user.estimated_delivery_date }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div> <!--// end panel body -->
            </div> <!--// end panel -->
            <br>
            <div class="panel panel-default">
                <div class="panel-heading"><h3>Requested Services</h3></div>
                <div class="panel-body">
                    <ul class="root">
                        {% recursetree display_service_for_user.nodes %}
                            <li>
                                {{ node }}
                                {% if not node.is_leaf_node %}
                                    <ul class="children">
                                        {{ children }}
                                    </ul>
                                    <BR>
                                {% endif %}
                            </li>
                        {% endrecursetree %}
                    </ul>
                </div> <!--// end panel body -->
            </div> <!--// end panel -->
        </div> <!--// end col-sm-6  general information from service  -->
        <div class="col-sm-5 col-sm-offset-1">
            <div class="col-sm-12">  <!-- Samples Requested services -->
                <div class="panel panel-default">
                    <div class="panel-heading"><h3>Calculation dates</h3></div>
                    <div class="panel-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Concept</th>
                                    <th>Number of days</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for date, value in display_service_for_user.calculation_dates %}
                                    <tr>
                                        <td> </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div> <!--// end panel body -->
                </div> <!--// end panel -->
            </div> <!--// end col-sm-12    -->
            <br>
            <div class="col-sm-12">  <!-- Samples Requested services -->
                <div class="panel panel-default">
                    <div class="panel-heading"><h3>Samples requested in service</h3></div>
                    <div class="panel-body">
                        <p>If click on the sample link a new tab window is opened</p>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Sample Name</th>
                                    <th>Project Name</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key, sample, project in display_service_for_user.samples %}
                                    <tr>
                                        <td><a href="/wetlab/displaySampleInRun={{ key }}"  target="_blank" rel="noopener noreferrer">{{sample}}</a> </td>
                                        <td>{{project}}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div> <!--// end panel body -->
                </div> <!--// end panel -->
            </div> <!--// end col-sm-12   samples Requested services  -->
        </div> <!--// end col-sm-6   samples Requested services  -->
    </div>   <!--// end row -->
    <div class="row row-space-2 margin-b-4">
        <div class="col-sm-12">  <!-- Notes in the Requested services -->
            <div class="panel panel-default">
                <div class="panel-heading"><h3>Notes included in the service request</h3></div>
                <div class="panel-body">
                    {{display_service_for_user.service_notes}}
                </div> <!--// end panel body -->
            </div> <!--// end panel -->
        </div> <!--// end col-sm-12   -->
    </div>   <!--// end row -->

{% elif display_service %}
    <h1><div class="color-heading">Service Information for the service {{ display_service.service_name}}</div></h1>
    <div class="row row-space-2 margin-b-4">
        <div class="col-sm-6">  <!-- general information from service -->
            <div class="panel panel-default">
                <div class="panel-heading"><h3>Service requested information</h3></div>
                <div class="panel-body">
                    <table class="table table-hover">
                        <tbody>
                            {% if display_service.resolution_folder %}
                                <tr>
                                   <td>Folder Name </td>
                                   <td>{{ display_service.resolution_folder }} </td>
                                </tr>
                            {% endif %}
                            <tr>
                                <td>Service Requested by:  </td>
                                <td> {{ display_service.user_name }} </td>
                            </tr>
                            <tr>
                                <td>Service is in State:  </td>
                                <td> {{ display_service.state }} </td>
                            </tr>

                            <tr>
                                <td>File uploaded for the service:  </td>
                                {% if display_service.file %}
                                    <td><a href="{{ display_service.file }}" download> File used  <span class="glyphicon glyphicon-download-alt"></span></a></td>
                                {% else %}
                                    <td>No file uploaded</td>
                                {% endif %}
                            </tr>

                            {% for text, value in display_service.service_dates %}
                                <tr>
                                    <td>{{ text }}</td>
                                    <td>{{ value }}</td>
                                </tr>
                            {% endfor%}
                            <tr>
                                <td>Estimated Delivery date </td>
                                <td>{{ display_service.estimated_delivery_date }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div> <!--// end panel body -->
            </div> <!--// end panel -->
        </div> <!--// end col-sm-6  general information from service  -->
        <div class="col-sm-6 ">  <!-- Actions  allowed-->
            <div class="panel panel-default">
                <div class="panel-heading"><h3>Allowed actions on {{ display_service.service_name}}</h3></div>
                <div class="panel-body">
                    <h5>Click on the following buttons to update the service</h5>

                    {% if display_service.add_resolution_action %}
                        <div class="row row-space-2 margin-b-4">
                            <div class="panel panel-default">
                                <div class="panel-heading"><h3>Select the services to add new resolution </h3></div>
                                <div class="panel-body">
                                    <form class="" action="/drylab/addResolution" method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="formToaddResolutionService">
                                        <input type="hidden" name="service_id" value="{{display_service.service_id}}">
                                        {% if display_service.multiple_services %}
                                            {% if display_service.first_resolution %}
                                                <p>Select the Service/Services for which you want to do the new resolution OR select None or all to handle all in the new resolution</p>
                                                <input type="hidden" name="children_services_id" value="{% for id, name in display_service.children_services %}{{id}},{% endfor %}">

                                                <div class="form-group">
                                                    <label class="col-sm-5 control-label" for="childrenServices" >Select services</label>
                                                    <div class="col-sm-10">
                                                       <select class="custom-select" name="childrenServices"  id="childrenServices" multiple>
                                                           {% for id, name in display_service.children_services %}
                                                               <option value="{{id}}">{{name}}</option>
                                                           {% endfor %}
                                                       </select>
                                                    </div>
                                                </div>  <!-- end from-group   -->
                                            {% else %}
                                                <input type="hidden" name="children_services_id" value="{% for id, name in display_service.pending_to_add_resolution %}{{id}},{% endfor %}">
                                                <div class="form-group">
                                                    <label class="col-sm-8 control-label" for="childrenServices" >Select services</label>

                                                    <div class="col-sm-8">
                                                        <select class="custom-select" name="childrenServices"  id="childrenServices" multiple>
                                                           {% for id, name in display_service.pending_to_add_resolution %}
                                                               <option value="{{id}}">{{name}}</option>
                                                           {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>  <!-- end from-group   -->
                                            {% endif %}
                                        {% endif %}
                                        <div class="col-sm-4 ">  <!-- col-sm-4  resolution button  -->
                                            <br><br>
                                            <input class="btn pull-right btn-primary" type="submit" id ="btnSubmit" value="Add Resolution">
                                        </div> <!--// end col-sm-4   resolution button  -->
                                    </form>
                                </div> <!--// end panel body -->
                            </div> <!--// end panel -->
                        </div> <!--// end row -->
                    {% endif%}
                    {% if display_service.resolution_for_progress %}
                        <div class="row row-space-2 margin-b-4">
                            <div class="panel panel-default">
                                <div class="panel-heading"><h3>Resolution to update the state to "In Progress"</h3></div>
                                <div class="panel-body">
                                    {% for res_id , res_name, services in display_service.resolution_for_progress %}
                                        <form class="" action="/drylab/addInProgress" method="post">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="inProgressResolutionService">
                                            <input type="hidden" name="resolution_id" value="{{res_id}}">
                                            <div class="col-sm-8 ">  <!-- col-sm-4  In progress button  -->
                                                <h5 style="text-align:center">{{res_name}}</h5>
                                                {% if services.0 != '' %}
                                                    <table>
                                                        <thead>
                                                            <tr>
                                                                <th>Resolution handle services</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for service in services %}
                                                                <tr>
                                                                    <td>{{service}}</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                {% endif %}
                                            </div> <!--// end col-sm-8 -->
                                            <div class="col-sm-3 col-sm-offset-1">  <!-- col-sm-3  progress button  -->
                                                <br>
                                                <input class="btn pull-right btn-primary" type="submit" id ="btnSubmit" value="In Progress">
                                            </div> <!--// end col-sm-4   resolution button  -->
                                        </form>
                                    {% endfor %}
                                </div> <!--// end panel body -->
                            </div> <!--// end panel -->
                        </div> <!--// end row -->
                    {% endif%}
                    {% if display_service.resolution_for_delivery %}
                        <div class="row row-space-2 margin-b-4">
                            <div class="panel panel-default">
                                <div class="panel-heading"><h3>Delivery resolutions</h3></div>
                                <div class="panel-body">
                                    {% for res_id , res_name, services in display_service.resolution_for_delivery %}
                                        <form class="" action="/drylab/addDelivery" method="post">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="deliveryResolutionService">
                                            <input type="hidden" name="resolution_id" value="{{res_id}}">
                                            <div class="col-sm-8 ">  <!-- col-sm-4  In progress button  -->
                                                <h5 style="text-align:center">{{res_name}}</h5>
                                                {% if services.0 != '' %}
                                                    <table>
                                                        <thead>
                                                            <tr>
                                                                <th>Resolution handle services</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for service in services %}
                                                                <tr>
                                                                    <td>{{service}}</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                {% endif %}
                                            </div> <!--// end col-sm-8 -->
                                            <div class="col-sm-3 col-sm-offset-1">  <!-- col-sm-3  progress button  -->
                                                <br>
                                                <input class="btn pull-right btn-primary" type="submit" id ="btnSubmit" value="Delivery">
                                            </div> <!--// end col-sm-4   resolution button  -->
                                        </form>
                                    {% endfor %}
                                </div> <!--// end panel body -->
                            </div> <!--// end panel -->
                        </div> <!--// end row -->
                    {% endif%}
                </div> <!--// end panel body -->
            </div> <!--// end panel -->
        </div> <!--// end col-sm-5  Actions  allowed  -->
    </div> <!--// end row -->

    <div class="row row-space-2 margin-b-4">
        <div class="col-sm-12">
            <div class="tab">
                    <button class="tablinks" onclick="summaryBin(event, 'request_services')"  id="defaultOpen">Requested Services</button>
                    <button class="tablinks" onclick="summaryBin(event, 'pipelines')">Pipelines</button>
                    <button class="tablinks" onclick="summaryBin(event, 'resolutions')">Resolutions</button>
                    <button class="tablinks" onclick="summaryBin(event, 'deliveries')">Deliveries</button>
            </div> <!--  end tabs -->
        <div class="col-sm-12">  <!-- Resolution and Delivery Information from service -->
            <div id="request_services" class="tabcontent">
                <div class="col-sm-6">
                    <div class="panel panel-default">
                        <div class="panel-heading"><h3>Requested Services</h3></div>
                        <div class="panel-body">
                            <ul class="root">
                                {% recursetree display_service.nodes %}
                                    <li>
                                        {{ node }}
                                        {% if not node.is_leaf_node %}
                                            <ul class="children">
                                                {{ children }}
                                            </ul>
                                            <BR>
                                        {% endif %}
                                    </li>
                                {% endrecursetree %}
                            </ul>
                        </div> <!--// end panel body -->
                    </div> <!--// end panel -->
                </div> <!--// end col-sm-6 -->
                <div class="col-sm-5 col-sm-offset-1">
                    <div class="col-sm-12">  <!-- Samples Requested services -->
                        <div class="panel panel-default">
                            <div class="panel-heading"><h3>Samples requested in service</h3></div>
                            <div class="panel-body">
                                <table class="table table-hover">
                                    <tbody>
                                        {% for key, value in display_service.samples %}
                                            <tr>
                                                <td><a href="/wetlab/displaySampleInRun={{ key }}"  target="_blank" rel="noopener noreferrer">{{value}}</a> </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div> <!--// end panel body -->
                        </div> <!--// end panel -->
                    </div> <!--// end col-sm-12   samples Requested services  -->
                    <div class="col-sm-12">  <!-- Notes in the Requested services -->
                        <div class="panel panel-default">
                            <div class="panel-heading"><h3>Notes included in the service request</h3></div>
                            <div class="panel-body">
                                {{display_service.service_notes}}
                            </div> <!--// end panel body -->
                        </div> <!--// end panel -->
                    </div> <!--// end col-sm-12  Projects Requested services  -->
                </div> <!--// end col-sm-5 -->
            </div><!-- // end of tab request_services -->

            <div id="pipelines" class="tabcontent">
                <div class="col-sm-6">
                    <div class="panel panel-default">
                        <div class="panel-heading"><h3>Pipelines used in this service </h3></div>
                        <div class="panel-body">
                            {% if display_service.pipelines_heading %}
                                {% for pipe, values in display_service.piplelines_data.items %}
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                {% for column in display_service.pipelines_heading %}
                                                    <th>{{column}}</th>
                                                {% endfor %}
                                           </tr>
                                        </thead>
                                        <tbody>
                                            {% for name, version, res_num in values %}
                                                <tr>

                                                    <td>{{name}}</td>
                                                    <td>{{version}}</td>
                                                    <td>{{res_num}}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <br><br>
                                {% endfor %}
                            {% else %}
                                <h5 style="text-align:center"> There are no pipelines used for the requested service</h5>
                            {% endif %}
                        </div> <!--// end panel body -->
                    </div> <!--// end panel -->
                </div> <!--// end col-sm-12  Projects Requested services  -->
            </div> <!--// end col-sm-5 -->
        </div><!-- // end of tab pipelines -->

            <div id="resolutions" class="tabcontent">
                <div class="col-sm-8">  <!-- Resolution information from service -->
                    <div class="panel panel-default">
                        <div class="panel-heading"><h3>Resolution requested information</h3></div>
                        <div class="panel-body">
                            {% if display_service.resolutions %}
                                    {% for resolution_number, resolution_information in display_service.resolutions %}
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th colspan= "2">Resolution Information for :  {{resolution_number}}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for values in resolution_information %}
                                                    <tr>
                                                        {% if forloop.first %}
                                                            {% if values.1.0 != 'None' %}
                                                                <td>{{values.0}}</td>
                                                                <td>
                                                                    {% for item in values.1 %}
                                                                        {{item}}<br>
                                                                    {% endfor %}
                                                                </td>
                                                            {% endif %}
                                                        {% elif forloop.last %}
                                                            <td>{{values.0}}</td>
                                                            <td><a href="{{values.1}}" download> Download file<span class="glyphicon glyphicon-download-alt"></span></a></td>
                                                        {% else %}
                                                            <td>{{values.0}}</td>
                                                            <td>{{values.1}} </td>
                                                        {% endif %}
                                                    </tr>
                                                {% endfor %}
                                           </tbody>
                                        </table>
                                    {% endfor %}
                                    <BR><BR>
                            {% else %}
                                <h5 style="text-align:center"> There are no resolutions assigned yet for the requested service</h5>
                            {% endif %}
                        </div> <!--// end panel body -->
                    </div> <!--// end panel -->
                </div> <!--// end col-sm-7  Resolution information from service  -->
            </div><!-- // end of tab resolutions -->
            <div id="deliveries" class="tabcontent">
                <div class="col-sm-6">  <!-- Resolution information from service -->
                    <div class="panel panel-default">
                        <div class="panel-heading"><h3>Delivery information</h3></div>
                        <div class="panel-body">
                            {% if display_service.delivery %}
                                {% for delivery  in display_service.delivery %}
                                    {% for  resolution_number, delivery_date, notes in delivery %}
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th colspan= "2">Delivery information  for Resolution {{ resolution_number }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Delivery Date:  </td>
                                                    <td> {{ delivery_date }} </td>
                                                </tr>
                                                <tr>
                                                    <td>Notes: </td>
                                                    <td>{{ notes }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    {% endfor %}
                                    <BR><BR>
                                {% endfor %}
                            {% else %}
                                <h5 style="text-align:center"> There are no deliveries done yet for the requested service</h5>
                            {% endif %}
                        </div> <!--// end panel body -->
                    </div> <!--// end panel -->
                </div> <!--// end col-sm-6  Deliveries information from service  -->
            </div><!-- // end of tab deliveries -->
        </div> <!--// end sm 12 -->
    </div>   <!--// end row -->
    <script>
        // Get the element with id="defaultOpen" and click on it
        document.getElementById("defaultOpen").click();
    </script>
{% endif %}
{% endblock %}
