{% extends 'iSkyLIMS_drylab/base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}
{% load crispy_forms_filters %}
{% load mptt_tags %}
{% load l10n %}
{%include 'iSkyLIMS_core/jexcel_functionality.html' %}
<style>
    .scrolling-wrapper {
        overflow-x: auto;
        overflow-y: auto;
        white-space: nowrap;
        height: 500px;
    }
 </style>

{% if error_message %}
    <div class="row row-space-2 margin-b-4">
        <div class="col-sm-7 col-sm-offset-3">
            <div class="panel panel-danger">
                <div class="panel-heading"><h3 style="text-align:center"></h3> </div>
                <div class="panel-body">
                    {% for values in error_message %}
                        <h4>{{values}}</h4>
                    {% endfor %}
                </div> <!--  end of panel body -->
            </div> <!--  end of panel  -->
        </div> <!--  end of col-sm-7 -->
    </div> <!--  end of row -->
{% endif %}
{% if confirmation_result %}
    <div class="row row-space-2 margin-b-4">
        <div class="col-sm-7 col-sm-offset-3">
            <div class="panel panel-default">
                <div class="panel-heading"><h3 style="text-align:center">Service Recorded</h3> </div>
                <div class="panel-body">
                    {% for values in confirmation_result.text %}
                        <h5>{{values}}</h5>
                    {% endfor %}
                    {% if confirmation_result.download_file %}
                        <p><a href="{{confirmation_result.download_file}}" download>Download Confirmation file  <span class="glyphicon glyphicon-download-alt"></span></a></p>

                    {% endif%}
                </div> <!--  end of panel body -->
            </div> <!--  end of panel  -->
        </div> <!--  end of col-sm-7 -->
    </div> <!--  end of row -->

{% else %}

    <div class="row row-space-2 margin-b-4">
        <div class="col-sm-12">
            <div class="panel panel-default">
                <div class="panel-heading"><h3 style="text-align:center">Available Samples.</h3></div>
                <div class="panel-body">
                    {% if service_data_information.samples_heading %}
                        <h5 style="text-align:center"> Select the samples to be included in the service</h5>

                        <div  class="scrolling-wrapper">
                            <div id="spreadsheet"></div>
                            <br>
                            <script>
                                var data = [{% for values in service_data_information.samples_data %}
                                   [{% for value in values %}'{{value}}',{% endfor %}],{% endfor %}
                                ];
                               mySpreadsheet = $('#spreadsheet').jexcel({
                                   data:data,
                                   columns: [
                                       {% for value in service_data_information.samples_heading %}
                                           {% if forloop.last %}
                                               { type: 'hidden' },
                                           {% else %}
                                               { type: 'text', title:'{{value}}', width:200 , readOnly:true },
                                           {% endif %}
                                       {% endfor %}
                                       { type: 'checkbox',  title:'Select Sample', width:100 },
                                    ],
                                    allowInsertColumn:false,
                                    allowDeleteColumn:false,
                                    allowRenameColumn:false,
                                    allowInsertRow:false,
                                    allowDeleteRow:false,
                                    tableOverflow:false,
                                    search:true,
                                    pagination:20,
                                    csvFileName:'SamplesDefined.csv',

                               });
                            </script>
                        </div> <!--  end of scrolling  -->
                    </div> <!--  end of panel body -->
                </div> <!--  end of panel  -->
            </div> <!--  end of col-sm-12 -->
        </div> <!--  end of row -->
    {% else %}
        <div class="row row-space-2 margin-b-4">
            <div class="col-sm-8 col-sm-offset-2" >
                <div class="panel panel-danger">
                    <div class="panel-heading"><h3 style="text-align:center">No Samples have been defined so far</h3></div>
                    <div class="panel-body">
                        <h5 style="text-align:center">Check the User Guide to define new Samples</h5>
                    </div> <!--  end of panel body -->
                </div> <!--  end of panel  -->
            </div> <!--  end of col-sm-12 -->
        </div> <!--  end of row -->
    {% endif %}

    {% if service_data_information.nodes %}
        <div class="row row-space-2 margin-b-4">
            <div class="col-sm-12">
                <div class="panel panel-default">
                    <div class="panel-heading"><h3 style="text-align:center">Requesting form Service</h3></div>
                    <div class="panel-body">
                        <div class="scrolling-wrapper">
                            <div class="controls {{field_class}}" {% if flat_attrs %} {{flat_attrs|safe}} {% endif %} >
                        		{% include "bootstrap3/layout/field_errors_block.html" %}
                        		{% for category,structure in service_data_information.nodes|tree_info %}

                                {% if structure.new_level %}<ul class="level-{{category.level}}" id="ul_{{forloop.counter}}"><li>{% else %}</li><li>{% endif %}
                                    <label class="checkbox{% if inline_class %}-{{ inline_class }}{% endif %}" >
                                        <input type="checkbox" {% if category.pk in value or category.pk|stringformat:"s" == value|stringformat:"s" %} checked="checked"{% endif %} class="level-{{category.level}}" name="InternalService" id="id_InternalService_{{forloop.counter}}" value="{{ category.pk }}" >
                                            {{ category }}
                        			 	</label>
                        			{% for level in structure.closed_levels %}</li></ul>{% endfor %}
                        		{% endfor %}
                        		{% include "bootstrap3/layout/help_text.html" %}
                    	    </div> <!--  end of scrolling wrapper -->
                        </div> <!--  end of scrolling wrapper -->
                    </div> <!--  end of panel body -->
                </div> <!--  end of panel  -->
            </div> <!--  end of col-sm-12 -->
        </div> <!--  end of row -->


        <script>
        $(document).ready(function() {
        	$("input:checkbox").change(function() {
        		var ischecked= $(this).is(':checked');
        		if (ischecked) {
        			$(this).parents().prevAll("label.checkbox").children("input:checkbox").prop("checked",true)
        		}else{
        		    $(this).parents().prevAll("label.checkbox").children("input:checkbox").prop("checked",false)
        		}
        	});
        });
        </script>
        <script>
            $(document).ready(function () {
                $("form").submit(function (e) {
                    //stop submitting the form to see the disabled button effect
                    // e.preventDefault();
                    //disable the submit button
                    $("input:submit").attr("disabled", true);
                    return true;
                });
            });
        </script>
        {% else %}
            <div class="row row-space-2 margin-b-4">
                <div class="col-sm-8 col-sm-offset-2" >
                    <div class="panel panel-danger">
                        <div class="panel-heading"><h3 style="text-align:center">No Services have been defined so far</h3></div>
                        <div class="panel-body">
                            <h5 style="text-align:center">Check the User Guide to define new Samples</h5>
                        </div> <!--  end of panel body -->
                    </div> <!--  end of panel  -->
                </div> <!--  end of col-sm-12 -->
            </div> <!--  end of row -->
        {% endif %}


        <script>
            $(document).ready(function () {
                $("#requestMoleculeUse").submit(function (e) {
                    //stop submitting the form to see the disabled button effect
                    // e.preventDefault();
                    //disable the submit button
                    var table_data = $('#spreadsheet').jexcel('getData')
                    var data_json = JSON.stringify(table_data)
                    $("<input />").attr("type", "hidden")
                        .attr("name", "samples_requested")
                        .attr("value", data_json)
                        .appendTo("#requestMoleculeUse");
                    $("#btnSubmit").attr("disabled", true);
                    return true;
                });
            });
       </script>
{% endif %}
{% endblock %}
